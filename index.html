<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Unified Life OS</title>
    <link rel="icon" type="image/png" href="./icon-g.png" />
    <link rel="apple-touch-icon" href="./icon-g.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="./icon-g.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Noto+Sans+TC:wght@300;400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #fbf7f2; /* ç°ç±³è‰² */
        --card: #fff9f6; /* å¥¶èŒ¶é¢æ¿ */
        --muted: #9b8b80; /* æš–å’–å•¡ */
        --accent: #b87b4a; /* æŸ”å’Œé‡é» */
        --accent-2: #d4a57a;
        --glass-shadow: 0 8px 22px rgba(30, 20, 15, 0.06);
        --radius: 14px;
        --sm-radius: 10px;
        --max-width: 1100px;
        font-family: "Inter", "Noto Sans TC", system-ui, -apple-system,
          "Segoe UI", Roboto, "Helvetica Neue", Arial;
        color: #2b2b2b;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        background: var(--bg);
      }
      .wrap {
        max-width: var(--max-width);
        margin: 22px auto;
        padding: 20px;
      }

      /* Top navigation */
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 18px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .logo {
        width: 46px;
        height: 46px;
        border-radius: 12px;
        background: linear-gradient(180deg, var(--accent-2), var(--accent));
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: 700;
        box-shadow: var(--glass-shadow);
      }
      .logo img {
        max-width: 100%;
      }
      .title {
        font-size: 18px;
        font-weight: 700;
      }
      .subtitle {
        font-size: 12px;
        color: var(--muted);
      }

      /* Top tabs nav */
      nav.top-tabs {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .tab {
        padding: 8px 12px;
        border-radius: 10px;
        background: transparent;
        border: none;
        font-weight: 600;
        color: var(--muted);
        cursor: pointer;
      }
      .tab.active {
        background: var(--card);
        box-shadow: var(--glass-shadow);
        color: var(--accent);
      }

      /* Right controls */
      .controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .icon-btn {
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 8px 12px;
        border-radius: 12px;
        cursor: pointer;
        box-shadow: 0 6px 14px rgba(184, 123, 74, 0.18);
      }

      /* Dashboard grid */
      main {
        display: grid;
        grid-template-columns: 1fr 340px;
        gap: 18px;
      }
      @media (max-width: 1000px) {
        main {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: var(--card);
        border-radius: var(--radius);
        padding: 16px;
        box-shadow: var(--glass-shadow);
      }
      .small {
        padding: 12px;
      }

      /* Focus area */
      .focus-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .focus-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.6);
      }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
      }
      .dot.high {
        background: #ff8a6b;
      }
      .dot.mid {
        background: #ffd29b;
      }
      .dot.low {
        background: #cfc7b8;
      }

      /* Task list */
      .task-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .task {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        border-radius: 10px;
        background: transparent;
        border: 1px dashed rgba(0, 0, 0, 0.03);
      }
      .task .title {
        font-weight: 600;
      }
      .task .meta {
        font-size: 12px;
        color: var(--muted);
      }

      /* Restock & Learning */
      .list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      /* Bottom area: history */
      .history {
        max-height: 180px;
        overflow: auto;
        padding-right: 6px;
      }

      /* Modal */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(10, 8, 6, 0.35);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 16px;
      }
      .modal {
        width: 100%;
        max-width: 540px;
        background: var(--card);
        border-radius: 14px;
        padding: 16px;
      }
      .modal h3 {
        margin: 0 0 8px 0;
      }
      .form-row {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }
      .form-row .col {
        flex: 1;
      }
      label {
        display: block;
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 4px;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.06);
        background: transparent;
      }
      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 12px;
      }
      .btn-ghost {
        background: transparent;
        border: 1px solid rgba(0, 0, 0, 0.06);
        padding: 8px 12px;
        border-radius: 10px;
      }

      /* mobile bottom nav */
      .bottom-nav {
        display: none;
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: 18px;
        background: var(--card);
        padding: 8px;
        border-radius: 20px;
        box-shadow: var(--glass-shadow);
        gap: 8px;
      }
      .bottom-nav button {
        border: none;
        background: transparent;
        padding: 8px 12px;
        border-radius: 10px;
      }
      @media (max-width: 700px) {
        header .top-tabs {
          display: none;
        }
        .bottom-nav {
          display: flex;
        }
        header {
          margin-bottom: 10px;
        }
        .wrap {
          padding: 12px;
        }
      }

      /* small helpers */
      .muted {
        color: var(--muted);
        font-size: 13px;
      }
      .flex {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .divider {
        height: 1px;
        background: rgba(0, 0, 0, 0.03);
        margin: 12px 0;
        border-radius: 2px;
      }

      /* drag handle */
      .drag-handle {
        cursor: grab;
        padding: 6px;
        border-radius: 6px;
      }

      /* completed style */
      .completed {
        opacity: 0.6;
        text-decoration: line-through;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="brand">
          <!-- <div class="logo">U</div> -->
          <div class="logo">
            <img src="./icon-g.png" alt="Unified Life OS" />
          </div>
          <div>
            <div class="title">Unified Life OS</div>
            <div class="subtitle">æ¸›å°‘èªçŸ¥ç–²å‹ â€¢ èšç„¦ç•¶ä¸‹çš„ç”Ÿæ´»ç³»çµ±</div>
          </div>
        </div>

        <div class="controls">
          <nav class="top-tabs" role="tablist">
            <button class="tab active" data-tab="focus">ğŸ“Œ ä»Šæ—¥ç„¦é»</button>
            <!-- <button class="tab" data-tab="tasks">ğŸ“ ä»»å‹™</button>
            <button class="tab" data-tab="restock">ğŸ›’ è£œè²¨</button>
            <button class="tab" data-tab="learning">ğŸ“š å­¸ç¿’é€²åº¦</button>
            <button class="tab" data-tab="settings">âš™ï¸ è¨­å®š</button> -->
          </nav>
          <button id="addBtn" class="icon-btn">ï¼‹ æ–°å¢</button>
        </div>
      </header>

      <main>
        <section id="leftCol">
          <!-- Focus card -->
          <div id="focusCard" class="card">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <div style="font-weight: 700">ä»Šæ—¥ç„¦é»</div>
              <div class="muted">åªé¡¯ç¤ºæœ€é‡è¦çš„ 3 ä»¶äº‹</div>
            </div>
            <div class="divider"></div>
            <div class="focus-list" id="focusList"></div>

            <div class="divider"></div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <div class="muted">åˆ°æœŸèˆ‡æé†’</div>
              <button class="btn-ghost" onclick="showTab('tasks')">
                æª¢è¦–å…¨éƒ¨
              </button>
            </div>
            <div id="dueList" style="margin-top: 10px"></div>
          </div>

          <!-- Tasks card -->
          <div id="tasksCard" class="card" style="margin-top: 16px">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
              "
            >
              <div style="font-weight: 700">ä»»å‹™æ¸…å–®</div>
              <div class="muted">æ‹–æ›³ä»¥æ’åº â€¢ å®Œæˆé …ç›®æœƒç§»è‡³æ­·å²</div>
            </div>
            <div
              class="task-list"
              id="taskList"
              ondragover="allowDrop(event)"
            ></div>

            <div class="divider"></div>
            <div>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                "
              >
                <div class="muted">å·²å®Œæˆæ­·å²</div>
                <button class="btn-ghost" onclick="clearHistory()">æ¸…é™¤</button>
              </div>
              <div class="history" id="historyList"></div>
            </div>
          </div>
        </section>

        <aside id="rightCol">
          <div class="card small">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <div style="font-weight: 700">è£œè²¨æé†’</div>
              <div class="muted">è‡ªå‹•å¾ªç’°é¡¯ç¤º</div>
            </div>
            <div class="list" id="restockList" style="margin-top: 10px"></div>
          </div>

          <div class="card small" style="margin-top: 14px">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <div style="font-weight: 700">å­¸ç¿’é€²åº¦</div>
              <div class="muted">å¿«é€Ÿ +10% æ›´æ–°</div>
            </div>
            <div class="list" id="learningList" style="margin-top: 10px"></div>
          </div>

          <!-- <div class="card small" style="margin-top: 14px">
            <div style="font-weight: 700">è¨­å®š (é ç•™)</div>
            <div class="muted" style="margin-top: 8px">
              æé†’æ–¹å¼ã€ä¸»é¡Œæ¨¡å¼ã€åŒ¯å…¥/åŒ¯å‡ºã€é›²ç«¯åŒæ­¥
            </div>
          </div> -->
        </aside>
      </main>

      <!-- Bottom nav for mobile -->
      <div class="bottom-nav" role="navigation">
        <button onclick="showTab('focus')">ğŸ“Œ</button>
        <button onclick="showTab('tasks')">ğŸ“</button>
        <button onclick="showTab('restock')">ğŸ›’</button>
        <button onclick="showTab('learning')">ğŸ“š</button>
        <button onclick="showTab('settings')">âš™ï¸</button>
      </div>
    </div>

    <!-- Modal (shared) -->
    <div class="modal-backdrop" id="modalBackdrop">
      <div class="modal">
        <h3 id="modalTitle">æ–°å¢é …ç›®</h3>
        <form id="itemForm" onsubmit="event.preventDefault(); saveItem();">
          <div class="form-row">
            <div class="col">
              <label>é¡å‹</label>
              <select id="field-type" required>
                <option value="task">ä»»å‹™</option>
                <option value="restock">è£œè²¨</option>
                <option value="learning">å­¸ç¿’ç´€éŒ„</option>
              </select>
            </div>
            <div class="col">
              <label id="label-name">åç¨±</label>
              <input
                id="field-name"
                placeholder="ä¾‹å¦‚ï¼šç¹³æˆ¿ç§Ÿ / è²·æ¿¾èŠ¯ / å‰ç«¯èª²ç¨‹"
                required
              />
            </div>
          </div>

          <div class="form-row" id="optionalRow">
            <div class="col">
              <label>å„ªå…ˆåº¦</label>
              <select id="field-priority">
                <option value="low">ä½</option>
                <option value="mid">ä¸­</option>
                <option value="high">é«˜</option>
              </select>
            </div>
            <div class="col" id="dateCol">
              <label>æˆªæ­¢æ—¥æœŸ</label>
              <input id="field-date" type="date" />
            </div>
          </div>

          <div class="form-row" id="restockRow" style="display: none">
            <div class="col">
              <label>è£œè²¨é–“éš” (å¤©)</label>
              <select id="field-interval">
                <option value="7">7</option>
                <option value="30">30</option>
                <option value="90">90</option>
                <option value="custom">è‡ªè¨‚</option>
              </select>
            </div>
            <div class="col" id="customIntervalCol" style="display: none">
              <label>è‡ªè¨‚å¤©æ•¸</label>
              <input id="field-interval-custom" type="number" min="1" />
            </div>
          </div>

          <div class="form-row" id="progressRow" style="display: none">
            <div class="col">
              <label>é€²åº¦ %</label>
              <input id="field-progress" type="number" min="0" max="100" />
            </div>
            <div class="col">
              <label>å‚™è¨»</label>
              <input id="field-note" />
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn-ghost" onclick="closeModal()">
              å–æ¶ˆ
            </button>
            <button type="submit" class="icon-btn">å„²å­˜</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      /* -------------------- Data layer (localStorage prototype) -------------------- */
      const STORAGE_KEY = "ulo_data_v1";
      let state = loadState();

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) return JSON.parse(raw);
        } catch (e) {}
        return { tasks: [], restocks: [], learnings: [], history: [] };
      }
      function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }

      /* -------------------- Helpers -------------------- */
      function uid() {
        return "id_" + Math.random().toString(36).slice(2, 9);
      }
      function daysBetween(a, b) {
        return Math.ceil((new Date(b) - new Date(a)) / (1000 * 60 * 60 * 24));
      }

      /* -------------------- Rendering -------------------- */
      function render() {
        renderFocus();
        renderTasks();
        renderRestocks();
        renderLearning();
        renderHistory();
      }

      /* Focus: choose top 3 by high priority + nearest deadline */
      function renderFocus() {
        const focusEl = document.getElementById("focusList");
        focusEl.innerHTML = "";
        const all = [...state.tasks];
        // filter incomplete
        const open = all.filter((t) => !t.done);
        // sort by priority (high->mid->low) then by date proximity
        const prio = { high: 0, mid: 1, low: 2 };
        open.sort((a, b) => {
          if (a.priority !== b.priority)
            return prio[a.priority] - prio[b.priority];
          if (a.due && b.due) return new Date(a.due) - new Date(b.due);
          if (a.due) return -1;
          if (b.due) return 1;
          return 0;
        });
        const top3 = open.slice(0, 3);
        top3.forEach((t) => {
          const el = document.createElement("div");
          el.className = "focus-item";
          const dot = document.createElement("div");
          dot.className = "dot " + t.priority;
          el.innerHTML = `<div style="flex:1"><div style='font-weight:700'>${escapeHtml(
            t.title
          )}</div><div class='muted' style='margin-top:6px'>${
            t.due ? "æˆªæ­¢ï¼š" + t.due : ""
          }</div></div>`;
          el.prepend(dot);
          focusEl.appendChild(el);
        });

        // due list
        const dueEl = document.getElementById("dueList");
        dueEl.innerHTML = "";
        const soon = open
          .filter((t) => t.due)
          .sort((a, b) => new Date(a.due) - new Date(b.due))
          .slice(0, 6);
        soon.forEach((t) => {
          const d = document.createElement("div");
          d.className = "muted";
          d.style.marginTop = "6px";
          const days = daysBetween(new Date(), new Date(t.due));
          d.textContent = `${t.title} â€” æˆªæ­¢ ${t.due} (${days} å¤©)`;
          dueEl.appendChild(d);
        });
      }

      function renderTasks() {
        const list = document.getElementById("taskList");
        list.innerHTML = "";
        state.tasks.forEach((t, idx) => {
          const item = document.createElement("div");
          item.className = "task";
          item.setAttribute("draggable", "true");
          item.dataset.id = t.id;
          item.ondragstart = dragStart;
          const left = document.createElement("div");
          left.style.display = "flex";
          left.style.alignItems = "center";
          left.style.gap = "8px";
          left.innerHTML = `<div class='drag-handle'>â‰¡</div><div><div class='title ${
            t.done ? "completed" : ""
          }'>${escapeHtml(t.title)}</div><div class='meta'>${
            t.due ? "æˆªæ­¢ï¼š" + t.due : ""
          } ${t.priority ? " â€¢ " + t.priority : ""}</div></div>`;
          const right = document.createElement("div");
          right.style.display = "flex";
          right.style.alignItems = "center";
          right.style.gap = "8px";
          const doneBtn = document.createElement("button");
          doneBtn.className = "btn-ghost";
          doneBtn.textContent = t.done ? "Undo" : "å®Œæˆ";
          doneBtn.onclick = () => toggleDone(t.id);
          const editBtn = document.createElement("button");
          editBtn.className = "btn-ghost";
          editBtn.textContent = "ç·¨è¼¯";
          editBtn.onclick = () => openModalForEdit(t.id);
          right.appendChild(doneBtn);
          right.appendChild(editBtn);
          item.appendChild(left);
          item.appendChild(right);
          list.appendChild(item);
        });
      }

      function renderRestocks() {
        const el = document.getElementById("restockList");
        el.innerHTML = "";
        // show items whose nextDate is today or earlier (remind) and also show upcoming
        const now = new Date();
        state.restocks.forEach((r) => {
          const next = new Date(r.nextDate || r.startDate || Date.now());
          const days = daysBetween(now, next);
          const item = document.createElement("div");
          item.className = "task";
          item.innerHTML = `<div><div class='title'>${escapeHtml(
            r.title
          )}</div><div class='muted'>ä¸‹æ¬¡ï¼š${formatDate(
            next
          )} (${days} å¤©)</div></div><div style='display:flex;gap:8px;align-items:center'><button class='btn-ghost' onclick='snoozeRestock("${
            r.id
          }")'>ç¨å¾Œ</button><button class='icon-btn' onclick='markRestocked("${
            r.id
          }")'>å·²è£œè²¨</button></div>`;
          el.appendChild(item);
        });
      }

      function renderLearning() {
        const el = document.getElementById("learningList");
        el.innerHTML = "";
        state.learnings.forEach((l) => {
          const item = document.createElement("div");
          item.className = "task";
          item.innerHTML = `<div><div class='title'>${escapeHtml(
            l.title
          )}</div><div class='muted'>é€²åº¦ï¼š${l.progress || 0}% ${
            l.note ? "â€¢ " + escapeHtml(l.note) : ""
          }</div></div><div style='display:flex;gap:8px'><button class='btn-ghost' onclick='incProgress("${
            l.id
          }")'>+10%</button><button class='btn-ghost' onclick='openModalForEdit("${
            l.id
          }")'>ç·¨è¼¯</button></div>`;
          el.appendChild(item);
        });
      }

      function renderHistory() {
        const el = document.getElementById("historyList");
        el.innerHTML = "";
        state.history
          .slice()
          .reverse()
          .forEach((h) => {
            const d = document.createElement("div");
            d.className = "muted";
            d.style.marginTop = "6px";
            d.textContent = `${h.title} â€¢ ${h.doneAt}`;
            el.appendChild(d);
          });
      }

      /* -------------------- Drag & Drop -------------------- */
      let dragSrcId = null;
      function dragStart(e) {
        dragSrcId = e.target.dataset.id;
      }
      function allowDrop(e) {
        e.preventDefault();
      }
      document.getElementById("taskList").addEventListener("drop", (e) => {
        const target = e.target.closest(".task");
        if (!target) return;
        const targetId = target.dataset.id;
        if (!dragSrcId || dragSrcId === targetId) return;
        const srcIdx = state.tasks.findIndex((x) => x.id === dragSrcId);
        const tgtIdx = state.tasks.findIndex((x) => x.id === targetId);
        const [moved] = state.tasks.splice(srcIdx, 1);
        state.tasks.splice(tgtIdx, 0, moved);
        saveState();
        render();
      });

      /* -------------------- Actions -------------------- */
      function toggleDone(id) {
        const idx = state.tasks.findIndex((t) => t.id === id);
        if (idx === -1) return;
        const t = state.tasks[idx];
        if (!t.done) {
          t.done = true;
          t.doneAt = new Date().toLocaleString();
          state.history.push({ title: t.title, doneAt: t.doneAt, id: uid() });
          // remove from tasks list
          state.tasks.splice(idx, 1);
        } else {
          // undo: move back
          t.done = false;
          state.tasks.push(t);
        }
        saveState();
        render();
      }

      function clearHistory() {
        if (confirm("ç¢ºå®šæ¸…é™¤å·²å®Œæˆæ­·å²ï¼Ÿ")) {
          state.history = [];
          saveState();
          render();
        }
      }

      function snoozeRestock(id) {
        const r = state.restocks.find((x) => x.id === id);
        if (!r) return;
        const next = new Date(r.nextDate || r.startDate || Date.now());
        next.setDate(next.getDate() + 7);
        r.nextDate = formatDate(next);
        saveState();
        render();
      }
      function markRestocked(id) {
        const r = state.restocks.find((x) => x.id === id);
        if (!r) return;
        const interval = parseInt(r.interval || 30, 10) || 30;
        const next = new Date();
        next.setDate(next.getDate() + interval);
        r.nextDate = formatDate(next);
        saveState();
        render();
      }

      function incProgress(id) {
        const l = state.learnings.find((x) => x.id === id);
        if (!l) return;
        l.progress = Math.min(100, (Number(l.progress) || 0) + 10);
        if (l.progress >= 100)
          state.history.push({
            title: l.title + "ï¼ˆå­¸ç¿’å®Œæˆï¼‰",
            doneAt: new Date().toLocaleString(),
            id: uid(),
          });
        saveState();
        render();
      }

      /* -------------------- Modal / Form -------------------- */
      const backdrop = document.getElementById("modalBackdrop");
      const form = document.getElementById("itemForm");
      let editTarget = null;

      document
        .getElementById("addBtn")
        .addEventListener("click", () => openModal());
      document
        .getElementById("field-type")
        .addEventListener("change", onTypeChange);
      document
        .getElementById("field-interval")
        .addEventListener("change", (e) => {
          document.getElementById("customIntervalCol").style.display =
            e.target.value === "custom" ? "block" : "none";
        });

      function onTypeChange() {
        const t = document.getElementById("field-type").value;
        document.getElementById("label-name").textContent =
          t === "task" ? "ä»»å‹™åç¨±" : t === "restock" ? "å•†å“åç¨±" : "èª²ç¨‹åç¨±";
        // show/hide rows
        document.getElementById("dateCol").style.display =
          t === "task" ? "block" : "none";
        document.getElementById("restockRow").style.display =
          t === "restock" ? "flex" : "none";
        document.getElementById("progressRow").style.display =
          t === "learning" ? "flex" : "none";
      }

      function openModal() {
        editTarget = null;
        document.getElementById("modalTitle").textContent = "æ–°å¢é …ç›®";
        form.reset();
        onTypeChange();
        backdrop.style.display = "flex";
      }
      function closeModal() {
        backdrop.style.display = "none";
      }

      function openModalForEdit(id) {
        // find item in each list
        editTarget = { type: "", id: id };
        let item = state.tasks.find((x) => x.id === id);
        if (item) {
          editTarget.type = "task";
          fillForm(item);
          backdrop.style.display = "flex";
          return;
        }
        item = state.restocks.find((x) => x.id === id);
        if (item) {
          editTarget.type = "restock";
          fillForm(item);
          backdrop.style.display = "flex";
          return;
        }
        item = state.learnings.find((x) => x.id === id);
        if (item) {
          editTarget.type = "learning";
          fillForm(item);
          backdrop.style.display = "flex";
          return;
        }
      }

      function fillForm(item) {
        form.reset();
        document.getElementById("field-type").value =
          item.type || (item.interval ? "restock" : "task");
        onTypeChange();
        document.getElementById("field-name").value =
          item.title || item.name || "";
        if (item.priority)
          document.getElementById("field-priority").value = item.priority;
        if (item.due) document.getElementById("field-date").value = item.due;
        if (item.interval)
          document.getElementById("field-interval").value = String(
            item.interval
          );
        if (item.nextDate)
          document.getElementById("field-interval-custom").value =
            item.nextDate;
        if (item.progress != null)
          document.getElementById("field-progress").value = item.progress;
        if (item.note) document.getElementById("field-note").value = item.note;
        document.getElementById("modalTitle").textContent = "ç·¨è¼¯é …ç›®";
      }

      function saveItem() {
        const type = document.getElementById("field-type").value;
        const name = document.getElementById("field-name").value.trim();
        const priority = document.getElementById("field-priority").value;
        const due = document.getElementById("field-date").value || null;
        const intervalSel = document.getElementById("field-interval").value;
        const intervalCustom = document.getElementById(
          "field-interval-custom"
        ).value;
        const progress = document.getElementById("field-progress").value;
        const note = document.getElementById("field-note").value;

        if (!name) return alert("è«‹è¼¸å…¥åç¨±");

        if (editTarget && editTarget.type === "task") {
          const t = state.tasks.find((x) => x.id === editTarget.id);
          if (t) {
            t.title = name;
            t.priority = priority;
            t.due = due;
            t.note = note;
            saveState();
            render();
            closeModal();
            return;
          }
        }
        if (editTarget && editTarget.type === "restock") {
          const r = state.restocks.find((x) => x.id === editTarget.id);
          if (r) {
            r.title = name;
            r.interval =
              intervalSel === "custom"
                ? Number(intervalCustom)
                : Number(intervalSel);
            saveState();
            render();
            closeModal();
            return;
          }
        }
        if (editTarget && editTarget.type === "learning") {
          const l = state.learnings.find((x) => x.id === editTarget.id);
          if (l) {
            l.title = name;
            l.progress = Number(progress || 0);
            l.note = note;
            saveState();
            render();
            closeModal();
            return;
          }
        }

        // create new
        if (type === "task") {
          const obj = {
            id: uid(),
            title: name,
            priority: priority || "low",
            due: due || null,
            type: "task",
            createdAt: new Date().toISOString(),
          };
          state.tasks.push(obj);
        } else if (type === "restock") {
          const interval =
            intervalSel === "custom"
              ? Number(intervalCustom) || 30
              : Number(intervalSel);
          const start = formatDate(new Date());
          const obj = {
            id: uid(),
            title: name,
            interval: interval,
            startDate: start,
            nextDate: start,
            type: "restock",
          };
          state.restocks.push(obj);
        } else if (type === "learning") {
          const obj = {
            id: uid(),
            title: name,
            progress: Number(progress || 0),
            note: note || "",
            type: "learning",
          };
          state.learnings.push(obj);
        }
        saveState();
        render();
        closeModal();
      }

      /* -------------------- Utilities -------------------- */
      function formatDate(d) {
        const dt = new Date(d);
        if (isNaN(dt)) return "";
        return dt.toISOString().slice(0, 10);
      }

      function escapeHtml(s) {
        return String(s)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      /* -------------------- Tab switching (simple, hides irrelevant sections on small screens) -------------------- */
      function showTab(tab) {
        document
          .querySelectorAll(".tab")
          .forEach((b) => b.classList.toggle("active", b.dataset.tab === tab));
        const left = document.getElementById("leftCol");
        const right = document.getElementById("rightCol");
        // small screen: only show relevant card(s)
        if (window.innerWidth <= 700) {
          if (tab === "focus") {
            left.style.display = "block";
            left
              .querySelectorAll(".card")
              .forEach((c) => (c.style.display = "block"));
            right.style.display = "none";
          } else if (tab === "tasks") {
            left.style.display = "block";
            left
              .querySelectorAll(".card")
              .forEach((c) => (c.style.display = "none"));
            document.getElementById("tasksCard").style.display = "block";
            right.style.display = "none";
          } else if (tab === "restock") {
            left.style.display = "none";
            right.style.display = "block";
            right
              .querySelectorAll(".card")
              .forEach((c) => (c.style.display = "none"));
            right.querySelector("[innerText]");
            document.querySelector(
              "#rightCol .card:nth-child(1)"
            ).style.display = "block";
          } else if (tab === "learning") {
            left.style.display = "none";
            right.style.display = "block";
            right
              .querySelectorAll(".card")
              .forEach((c) => (c.style.display = "none"));
            document.querySelector(
              "#rightCol .card:nth-child(2)"
            ).style.display = "block";
          } else {
            left.style.display = "none";
            right.style.display = "block";
            right
              .querySelectorAll(".card")
              .forEach((c) => (c.style.display = "block"));
          }
        } else {
          left.style.display = "block";
          right.style.display = "block";
          document.querySelectorAll(".tab").forEach((b) => {});
        }
      }

      /* initial render */
      render();

      // close modal when clicking backdrop
      backdrop.addEventListener("click", (e) => {
        if (e.target === backdrop) closeModal();
      });

      // accessibility: Esc to close
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeModal();
      });

      /* -------------------- On first load: sample data for demo (only if empty) -------------------- */
      if (
        state.tasks.length === 0 &&
        state.restocks.length === 0 &&
        state.learnings.length === 0
      ) {
        state.tasks.push({
          id: uid(),
          title: "ç¹³æˆ¿ç§Ÿ",
          priority: "high",
          due: nextDateStr(27),
          type: "task",
        });
        state.tasks.push({
          id: uid(),
          title: "å‹å‹•éƒ¨èª²ç¨‹",
          priority: "high",
          due: nextDateStr(13),
          type: "task",
        });
        state.tasks.push({
          id: uid(),
          title: "æ•´ç†é›»è…¦æª”æ¡ˆ",
          priority: "mid",
          due: null,
          type: "task",
        });
        state.restocks.push({
          id: uid(),
          title: "è¡›ç”Ÿç´™",
          interval: 90,
          startDate: formatDate(new Date()),
          nextDate: formatDate(new Date()),
        });
        state.learnings.push({
          id: uid(),
          title: "å‰ç«¯æ¡†æ¶èª²ç¨‹",
          progress: 20,
          note: "æ¯é€±å…©å ‚",
          type: "learning",
        });
        saveState();
        render();
      }

      function nextDateStr(days) {
        const d = new Date();
        d.setDate(d.getDate() + days);
        return formatDate(d);
      }
    </script>
  </body>
</html>
